#include <tunables/global>

/opt/novacron/bin/api-server flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/ssl_certs>
  
  # Executable
  /opt/novacron/bin/api-server mr,
  
  # Configuration files
  /etc/novacron/** r,
  /opt/novacron/config/** r,
  
  # Data directories
  /var/lib/novacron/** rw,
  /var/log/novacron/** rw,
  
  # Temporary files
  /tmp/** rw,
  /var/tmp/** rw,
  
  # Process information
  @{PROC}/sys/kernel/random/uuid r,
  @{PROC}/meminfo r,
  @{PROC}/stat r,
  @{PROC}/loadavg r,
  
  # Network
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,
  network unix stream,
  network unix dgram,
  network netlink raw,
  
  # Signal handling
  signal (receive) set=(term, kill, int, quit, hup, usr1, usr2),
  signal (send) set=(term, kill, int, quit, hup, usr1, usr2) peer=unconfined,
  
  # Library access
  /lib{,32,64}/** mr,
  /usr/lib{,32,64}/** mr,
  
  # System information
  /sys/class/net/ r,
  /sys/class/net/*/statistics/* r,
  /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq r,
  
  # Database connections (PostgreSQL)
  /var/run/postgresql/.s.PGSQL.* rw,
  
  # Certificate management
  /etc/ssl/certs/ r,
  /etc/ssl/certs/** r,
  /usr/share/ca-certificates/** r,
  
  # Deny dangerous capabilities
  deny capability sys_admin,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability dac_read_search,
  deny capability dac_override,
  
  # Allow specific capabilities needed
  capability net_bind_service,
  
  # Logging
  /dev/log w,
}

# Child profiles for spawned processes
profile novacron-api-child flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  
  /bin/bash ix,
  /usr/bin/** ix,
  /opt/novacron/bin/** ix,
  
  # Temporary execution
  /tmp/** rw,
  
  # Standard I/O
  /dev/null rw,
  /dev/zero r,
  /dev/urandom r,
}