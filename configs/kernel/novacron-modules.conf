# NovaCron Kernel Module Configuration
# Ubuntu 24.04 LTS - Kernel modules for optimal virtualization performance
# Install to: /etc/modules-load.d/novacron.conf

# =============================================================================
# CORE VIRTUALIZATION MODULES
# =============================================================================

# KVM core module - Hardware-assisted virtualization
# Impact: Essential for VM performance, provides CPU virtualization
kvm

# Intel VT-x support (load only on Intel systems)
# Impact: 25-40% better VM CPU performance vs software emulation
kvm_intel

# AMD-V support (load only on AMD systems)  
# Impact: 25-40% better VM CPU performance vs software emulation
kvm_amd

# =============================================================================
# VFIO MODULES FOR DEVICE PASSTHROUGH
# =============================================================================

# VFIO core module - Base for device passthrough
# Impact: Enables GPU/device passthrough for VMs
vfio

# VFIO PCI driver - PCI device passthrough
# Impact: Required for GPU passthrough, high-performance I/O devices
vfio_pci

# VFIO IOMMU Type1 driver - Memory management for passthrough
# Impact: Essential for secure device passthrough
vfio_iommu_type1

# VFIO virqfd - Interrupt handling for passthrough devices
# Impact: Optimizes interrupt delivery for passthrough devices
vfio_virqfd

# =============================================================================
# NETWORK VIRTUALIZATION MODULES
# =============================================================================

# Bridge module - VM network bridging
# Impact: 15-25% better network performance vs NAT
bridge

# 802.1Q VLAN support - VLAN tagging for VM networks
# Impact: Enables network isolation and QoS for VMs
8021q

# TUN/TAP driver - Virtual network interfaces for VMs
# Impact: Essential for VM network connectivity
tun

# Virtual Ethernet pair - Container networking
# Impact: Required for container-based VMs and network namespaces  
veth

# Overlay network support - Software-defined networking
# Impact: Enables advanced networking features for VM clusters
overlay

# Netfilter bridge - Firewall for bridged VM networks
# Impact: Enables security policies for VM network traffic
br_netfilter

# =============================================================================
# STORAGE VIRTUALIZATION MODULES
# =============================================================================

# Loop device support - Disk image mounting
# Impact: Essential for VM disk image handling
loop

# Device mapper - LVM and storage abstraction
# Impact: Enables advanced storage features for VMs
dm_mod

# Device mapper multipath - Redundant storage paths
# Impact: Improves storage reliability and performance
dm_multipath

# NBD (Network Block Device) - Network-attached storage
# Impact: Enables shared storage for VM migration
nbd

# SCSI generic driver - SCSI device passthrough
# Impact: Required for storage device passthrough to VMs
sg

# =============================================================================
# PERFORMANCE OPTIMIZATION MODULES
# =============================================================================

# CPU frequency scaling - Performance governor support
# Impact: Enables CPU performance optimization
cpufreq_performance

# Intel P-State driver (Intel CPUs only)
# Impact: Advanced CPU frequency management
# Note: Often disabled via kernel params for consistent performance
intel_pstate

# AMD P-State driver (AMD CPUs only)
# Impact: Advanced CPU frequency management for AMD
amd_pstate

# CPU idle driver optimization
# Impact: Reduces CPU idle state transitions for better VM latency
intel_idle

# =============================================================================
# MONITORING AND DEBUGGING MODULES
# =============================================================================

# Hardware monitoring - Temperature and fan control
# Impact: Prevents thermal throttling that degrades VM performance
coretemp
k10temp

# Performance monitoring - Hardware performance counters
# Impact: Enables detailed VM performance analysis
perf

# Intel RAPL - Power monitoring and control
# Impact: Allows power-aware VM scheduling
intel_rapl_common
intel_rapl_msr

# =============================================================================
# SECURITY MODULES (OPTIONAL)
# =============================================================================

# AppArmor - Mandatory access control
# Impact: Security isolation for VM processes
# Note: Can impact performance by 2-5%
# apparmor

# SELinux - Security-enhanced Linux
# Impact: Fine-grained security policies
# Note: Can impact performance by 3-8%  
# selinux

# =============================================================================
# CONTAINER SUPPORT MODULES
# =============================================================================

# Container runtime support - For container-based VMs
# Impact: Enables container virtualization alongside KVM
overlay
aufs
devicemapper

# Cgroup support - Resource management for containers
# Impact: Enables resource limits and QoS for container VMs
cgroup_v1
cgroup_v2

# Namespace support - Process isolation for containers
# Impact: Essential for container security and isolation
pid_ns
net_ns
user_ns
ipc_ns
uts_ns

# =============================================================================
# GPU AND ACCELERATION MODULES
# =============================================================================

# NVIDIA support (if NVIDIA GPUs present)
# Impact: Enables GPU passthrough and virtualization
# Note: Requires NVIDIA proprietary drivers
# nvidia
# nvidia_uvm
# nvidia_modeset

# Intel integrated graphics support
# Impact: Enables Intel GPU virtualization and passthrough
i915

# AMD graphics support  
# Impact: Enables AMD GPU virtualization and passthrough
amdgpu
radeon

# =============================================================================
# MODULE PARAMETER OPTIMIZATION
# =============================================================================

# This section documents optimal module parameters
# These should be set in /etc/modprobe.d/novacron.conf

# KVM module parameters for optimal performance:
# options kvm halt_poll_ns=500000
# options kvm_intel nested=1 enable_shadow_vmcs=1 enable_apicv=1 ept=1 vpid=1 flexpriority=1
# options kvm_amd nested=1 npt=1

# VFIO module parameters:
# options vfio_iommu_type1 allow_unsafe_interrupts=1
# options vfio_pci ids=10de:1b81 # Example: NVIDIA GTX 1070

# Network module parameters:
# options bridge forward_delay=0
# options br_netfilter enable=1

# =============================================================================
# PERFORMANCE IMPACT ESTIMATES
# =============================================================================
#
# Critical Modules (Essential for VM operation):
# - kvm, kvm_intel/kvm_amd: Base VM functionality
# - bridge, tun: VM network connectivity
# - loop, dm_mod: VM storage support
#
# High Performance Impact (>15% improvement):
# - vfio_pci: 50-80% performance improvement for GPU passthrough
# - 8021q, overlay: 20-30% network performance with proper configuration
# - dm_multipath: 25-40% storage reliability improvement
#
# Medium Performance Impact (5-15% improvement):
# - cpufreq_performance: 5-15% CPU performance consistency
# - coretemp, k10temp: Prevents thermal throttling
# - perf: Enables performance optimization (no direct impact)
#
# Low Performance Impact (1-5% improvement):
# - Various namespace modules: Enable advanced features
# - Monitoring modules: Enable observability
#
# Performance Overhead (slight impact):
# - apparmor: 2-5% CPU overhead
# - selinux: 3-8% CPU overhead
# - Security modules trade performance for security
#
# =============================================================================
# LOADING ORDER AND DEPENDENCIES
# =============================================================================
#
# Critical loading order:
# 1. Core modules (kvm, vfio)
# 2. CPU-specific modules (kvm_intel/kvm_amd)
# 3. Device modules (vfio_pci, device passthrough)
# 4. Network modules (bridge, tun, overlays)
# 5. Storage modules (dm_mod, multipath)
# 6. Performance modules (cpufreq, monitoring)
#
# The systemd modules-load service handles dependencies automatically
#
# =============================================================================