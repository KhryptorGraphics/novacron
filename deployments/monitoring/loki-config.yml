# Loki Configuration for DWCP v3 Log Aggregation
# High-performance log aggregation with structured logging support

auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096
  log_level: info
  log_format: json

  grpc_server_max_recv_msg_size: 33554432  # 32MB
  grpc_server_max_send_msg_size: 33554432  # 32MB
  grpc_server_max_concurrent_streams: 1000

  http_server_read_timeout: 1m
  http_server_write_timeout: 1m
  http_server_idle_timeout: 2m

distributor:
  ring:
    kvstore:
      store: memberlist
      prefix: collectors/
    heartbeat_timeout: 1m

ingester:
  lifecycler:
    ring:
      kvstore:
        store: memberlist
      replication_factor: 3
      heartbeat_period: 5s
      heartbeat_timeout: 1m
    join_after: 10s
    min_ready_duration: 10s
    final_sleep: 30s
    num_tokens: 512

  # Chunk configuration
  chunk_idle_period: 5m
  chunk_block_size: 262144
  chunk_retain_period: 1m
  max_chunk_age: 1h
  chunk_encoding: gzip

  # WAL configuration
  wal:
    enabled: true
    dir: /loki/wal
    checkpoint_duration: 5m
    flush_on_shutdown: true
    replay_memory_ceiling: 4GB

  # Limits per stream
  max_transfer_retries: 0
  concurrent_flushes: 32

schema_config:
  configs:
    # Current schema (v12)
    - from: 2024-01-01
      store: boltdb-shipper
      object_store: s3
      schema: v12
      index:
        prefix: loki_index_
        period: 24h

    # Future schema (v13) for better performance
    - from: 2025-01-01
      store: tsdb
      object_store: s3
      schema: v13
      index:
        prefix: loki_tsdb_index_
        period: 24h

storage_config:
  # BoltDB Shipper for index storage
  boltdb_shipper:
    active_index_directory: /loki/index
    cache_location: /loki/index_cache
    cache_ttl: 24h
    shared_store: s3
    index_gateway_client:
      server_address: loki-index-gateway:9095

  # S3 configuration for log storage
  aws:
    s3: s3://us-east-1/dwcp-v3-logs
    endpoint: s3.amazonaws.com
    region: us-east-1
    access_key_id: ${AWS_ACCESS_KEY_ID}
    secret_access_key: ${AWS_SECRET_ACCESS_KEY}
    s3forcepathstyle: false
    insecure: false

    # Optimizations
    http_config:
      idle_conn_timeout: 90s
      response_header_timeout: 0s
      insecure_skip_verify: false
      max_idle_connections: 100
      max_idle_connections_per_host: 100
      max_conns_per_host: 0

  # Filesystem storage (for testing/dev)
  filesystem:
    directory: /loki/chunks

  # Index caching
  index_queries_cache_config:
    memcached:
      batch_size: 256
      parallelism: 10
    memcached_client:
      host: memcached-index:11211
      service: memcached-client
      timeout: 500ms
      max_idle_conns: 100
      update_interval: 1m
      consistent_hash: true

  # Chunk caching
  cache_config:
    memcached:
      batch_size: 256
      parallelism: 10
    memcached_client:
      host: memcached:11211
      service: memcached-client
      timeout: 500ms
      max_idle_conns: 100
      update_interval: 1m
      consistent_hash: true

    # Results cache
    results_cache:
      cache:
        memcached_client:
          host: memcached-results:11211
          timeout: 500ms
          max_idle_conns: 16
          update_interval: 1m
          consistent_hash: true

compactor:
  working_directory: /loki/compactor
  shared_store: s3
  compaction_interval: 10m
  retention_enabled: true
  retention_delete_delay: 2h
  retention_delete_worker_count: 150

  # Compaction limits
  max_compaction_parallelism: 1
  upload_parallelism: 10

limits_config:
  # Ingestion limits
  ingestion_rate_mb: 50
  ingestion_burst_size_mb: 100

  # Per-tenant limits
  max_global_streams_per_user: 10000
  max_streams_per_user: 0
  max_streams_matchers_per_query: 1000

  # Query limits
  max_query_length: 721h  # 30 days
  max_query_parallelism: 32
  max_query_series: 10000
  max_entries_limit_per_query: 10000

  # Cardinality limits
  max_label_name_length: 1024
  max_label_value_length: 2048
  max_label_names_per_series: 30

  # Line size limits
  max_line_size: 256KB
  max_line_size_truncate: false

  # Retention (30 days default, can be overridden per tenant)
  retention_period: 720h

  # Split queries
  split_queries_by_interval: 30m
  max_query_lookback: 30d

  # Reject old samples
  reject_old_samples: true
  reject_old_samples_max_age: 168h  # 7 days
  creation_grace_period: 10m

  # Unordered writes
  unordered_writes: true
  max_chunks_per_query: 2000000

  # Per-stream rate limits
  per_stream_rate_limit: 5MB
  per_stream_rate_limit_burst: 20MB

  # Ruler limits
  ruler_evaluation_delay_duration: 1m
  ruler_max_rules_per_rule_group: 20
  ruler_max_rule_groups_per_tenant: 70

ruler:
  storage:
    type: local
    local:
      directory: /loki/rules
  rule_path: /loki/rules-temp
  alertmanager_url: http://alertmanager:9093
  ring:
    kvstore:
      store: memberlist
  enable_api: true
  enable_alertmanager_v2: true

  # Remote write for Prometheus
  remote_write:
    enabled: true
    client:
      url: http://prometheus:9090/api/v1/write
      timeout: 10s
      queue_config:
        capacity: 10000
        max_shards: 10
        max_samples_per_send: 1000
        batch_send_deadline: 5s
        min_backoff: 30ms
        max_backoff: 100ms

table_manager:
  retention_deletes_enabled: true
  retention_period: 720h  # 30 days

query_range:
  # Results caching
  results_cache:
    cache:
      memcached_client:
        host: memcached-results:11211
        timeout: 500ms
        max_idle_conns: 16
        update_interval: 1m
        consistent_hash: true

  # Cache results for 10m
  cache_results: true
  max_retries: 5

  # Parallelization
  parallelise_shardable_queries: true
  split_queries_by_interval: 30m

  # Query statistics
  max_query_length: 721h
  max_query_parallelism: 32

  # Align queries to step
  align_queries_with_step: true

frontend:
  # Log query frontend settings
  max_outstanding_per_tenant: 2048
  compress_responses: true
  log_queries_longer_than: 5s

  # Query stats
  tail_proxy_url: http://loki-querier:3100

  # Scheduler
  scheduler_address: loki-query-scheduler:9095

  # Downstream URL for queries
  downstream_url: http://loki-querier:3100

frontend_worker:
  # Number of concurrent queries per worker
  parallelism: 10
  match_max_concurrent: true

  # Query scheduler
  scheduler_address: loki-query-scheduler:9095

  # DNS lookup
  dns_lookup_period: 10s

memberlist:
  node_name: ${HOSTNAME}
  bind_port: 7946
  join_members:
    - loki-gossip-ring:7946
  dead_node_reclaim_time: 30s
  gossip_interval: 1s
  gossip_nodes: 3
  retransmit_factor: 2

# Analytics and telemetry
analytics:
  reporting_enabled: false

# Tracing integration
tracing:
  enabled: true
  jaeger:
    agent_host: jaeger-agent
    agent_port: 6831
    sampler_type: probabilistic
    sampler_param: 0.1  # 10% sampling

# Runtime configuration
runtime_config:
  file: /etc/loki/runtime.yaml
  period: 10s
