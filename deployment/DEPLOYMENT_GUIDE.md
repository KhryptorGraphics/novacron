# NovaCron Production Deployment Guide

This guide provides comprehensive instructions for deploying NovaCron in production environments using either Docker Swarm or Kubernetes.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Security Setup](#security-setup)
3. [Environment Configuration](#environment-configuration)
4. [Deployment Options](#deployment-options)
5. [Post-Deployment](#post-deployment)
6. [Monitoring & Maintenance](#monitoring--maintenance)
7. [Troubleshooting](#troubleshooting)

## Prerequisites

### System Requirements

**Minimum Requirements:**
- CPU: 4 cores
- RAM: 8GB
- Storage: 100GB SSD
- Network: 1Gbps

**Recommended (Production):**
- CPU: 8+ cores
- RAM: 16GB+
- Storage: 200GB+ SSD
- Network: 1Gbps+

### Software Dependencies

```bash
# Required
- Docker 20.10+
- Docker Compose 2.0+
- Git
- curl
- jq
- openssl

# For Kubernetes deployment
- kubectl 1.25+
- helm 3.8+

# For Docker Swarm deployment  
- Docker Swarm mode enabled
```

### Installation Commands

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y docker.io docker-compose-plugin git curl jq openssl

# CentOS/RHEL
sudo yum install -y docker docker-compose git curl jq openssl

# Enable and start Docker
sudo systemctl enable docker
sudo systemctl start docker
sudo usermod -aG docker $USER
```

## Security Setup

### 1. Generate Secrets

```bash
cd /path/to/novacron
./scripts/production/generate-secrets.sh production
```

This creates:
- Database credentials
- JWT secrets
- Redis passwords
- Grafana admin credentials
- Encryption keys
- API keys

### 2. SSL Certificates

#### Option A: Let's Encrypt (Recommended)
```bash
./scripts/production/ssl/generate-ssl.sh letsencrypt your-domain.com
```

#### Option B: Self-Signed (Development/Testing)
```bash
./scripts/production/ssl/generate-ssl.sh self-signed your-domain.com
```

#### Option C: Import Existing Certificates
```bash
export SSL_CERT_SOURCE=/path/to/your/cert.pem
export SSL_KEY_SOURCE=/path/to/your/key.pem
./scripts/production/ssl/generate-ssl.sh import your-domain.com
```

### 3. Environment Variables

Edit the environment configuration:
```bash
cp deployment/configs/.env.production.example deployment/configs/.env.production
vim deployment/configs/.env.production
```

Required variables:
- `DOMAIN_NAME`: Your production domain
- `POSTGRES_PASSWORD`: Strong database password
- `JWT_SECRET`: Secure JWT signing key
- `GRAFANA_ADMIN_PASSWORD`: Grafana admin password

## Environment Configuration

### Production Environment File

```bash
# deployment/configs/.env.production
ENVIRONMENT=production
DOMAIN_NAME=your-domain.com
API_BASE_URL=https://your-domain.com/api

# Database (generated by secrets script)
POSTGRES_HOST=postgres
POSTGRES_USER=novacron_prod
POSTGRES_PASSWORD=<generated-secure-password>
POSTGRES_DB=novacron_production

# Redis (generated by secrets script)
REDIS_PASSWORD=<generated-secure-password>

# Authentication (generated by secrets script)
JWT_SECRET=<generated-jwt-secret>

# SSL Configuration
SSL_ENABLED=true
SSL_CERT_PATH=/etc/ssl/certs/novacron.crt
SSL_KEY_PATH=/etc/ssl/private/novacron.key

# Monitoring
GRAFANA_ADMIN_PASSWORD=<generated-password>
PROMETHEUS_RETENTION=30d

# Backup Configuration
BACKUP_ENABLED=true
BACKUP_S3_BUCKET=your-backup-bucket
BACKUP_S3_REGION=us-east-1

# Resource Limits
API_REPLICAS=3
FRONTEND_REPLICAS=2
DB_MAX_CONNECTIONS=200

# Security
RATE_LIMIT_ENABLED=true
CSRF_ENABLED=true
SECURE_COOKIES=true
```

### Directory Structure

```bash
# Create required directories
sudo mkdir -p /opt/novacron/{data,backups,logs}
sudo mkdir -p /opt/novacron/data/{postgres,redis,prometheus,grafana}
sudo chown -R $USER:$USER /opt/novacron
```

## Deployment Options

### Option 1: Docker Swarm (Recommended for Single-Node)

#### Initialize Swarm
```bash
# Initialize Docker Swarm
docker swarm init --advertise-addr $(hostname -I | cut -d' ' -f1)

# Add worker nodes (optional)
docker swarm join-token worker
```

#### Deploy
```bash
./scripts/production/deploy.sh docker-swarm production
```

#### Manual Steps
```bash
# Create networks
docker network create --driver overlay --attachable novacron-frontend
docker network create --driver overlay --attachable novacron-backend
docker network create --driver overlay novacron-database

# Deploy stack
docker stack deploy -c deployment/docker/docker-compose.swarm.yml novacron

# Verify deployment
docker stack services novacron
docker service logs novacron_api
```

### Option 2: Kubernetes (Recommended for Multi-Node)

#### Prerequisites
```bash
# Ensure kubectl is configured
kubectl cluster-info

# Create namespaces
kubectl apply -f deployment/kubernetes/namespace.yaml
```

#### Deploy
```bash
./scripts/production/deploy.sh kubernetes production
```

#### Manual Steps
```bash
# Apply configurations in order
kubectl apply -f deployment/kubernetes/rbac.yaml
kubectl apply -f deployment/kubernetes/storage.yaml
kubectl apply -f deployment/kubernetes/configmap.yaml

# Create secrets (if not using script)
kubectl create secret generic postgres-credentials \
  --from-literal=username=novacron_prod \
  --from-literal=password=your-secure-password \
  --namespace=novacron

# Deploy applications
kubectl apply -f deployment/kubernetes/postgres.yaml
kubectl apply -f deployment/kubernetes/redis.yaml
kubectl apply -f deployment/kubernetes/api-deployment.yaml
kubectl apply -f deployment/kubernetes/frontend-deployment.yaml
kubectl apply -f deployment/kubernetes/services.yaml
kubectl apply -f deployment/kubernetes/ingress.yaml

# Verify deployment
kubectl get pods -n novacron
kubectl get services -n novacron
```

### Option 3: Docker Compose (Development/Testing)

```bash
# Use the production compose file
docker-compose -f deployment/docker/docker-compose.production.yml up -d

# Or use the simplified version
docker-compose -f docker-compose.improved.yml up -d
```

## Post-Deployment

### 1. Health Verification

```bash
# Run comprehensive health check
./scripts/production/validation/health-check.sh production

# Run smoke tests
./scripts/production/validation/smoke-tests.sh production
```

### 2. Initial Configuration

```bash
# Access the application
curl https://your-domain.com/health

# Check API status
curl https://your-domain.com/api/info

# Access Grafana (admin/your-password)
open https://your-domain.com/grafana
```

### 3. Database Migration

```bash
# If using Kubernetes
kubectl exec -it deployment/novacron-api -n novacron -- /app/migrate

# If using Docker Swarm
docker exec -it $(docker ps -q -f name=novacron_api) /app/migrate
```

## Monitoring & Maintenance

### Setup Monitoring

```bash
# Deploy monitoring stack
./scripts/production/monitoring/setup-monitoring.sh production
```

This sets up:
- Prometheus metrics collection
- Grafana dashboards
- Alertmanager notifications
- Log aggregation
- Performance monitoring

### Access Monitoring Tools

- **Grafana**: https://your-domain.com/grafana
- **Prometheus**: https://your-domain.com/prometheus
- **Alertmanager**: https://your-domain.com/alertmanager

### Backup Configuration

```bash
# Manual backup
./scripts/production/backup/create-backup.sh backup-$(date +%Y%m%d)

# Automated backups (via cron)
0 2 * * * /path/to/novacron/scripts/production/backup/create-backup.sh nightly-$(date +\%Y\%m\%d)
```

### SSL Certificate Renewal

```bash
# Manual renewal (Let's Encrypt)
certbot renew

# Copy renewed certificates
sudo cp /etc/letsencrypt/live/your-domain.com/fullchain.pem /path/to/deployment/ssl/cert.pem
sudo cp /etc/letsencrypt/live/your-domain.com/privkey.pem /path/to/deployment/ssl/key.pem

# Restart services
docker service update --force novacron_frontend  # Swarm
kubectl rollout restart deployment/novacron-frontend -n novacron  # Kubernetes
```

## Troubleshooting

### Common Issues

#### 1. Services Won't Start

```bash
# Check logs
docker service logs novacron_api  # Swarm
kubectl logs deployment/novacron-api -n novacron  # Kubernetes

# Check resource usage
docker stats
kubectl top pods -n novacron

# Verify secrets
docker secret ls  # Swarm
kubectl get secrets -n novacron  # Kubernetes
```

#### 2. Database Connection Issues

```bash
# Test database connectivity
docker exec -it novacron_postgres psql -U novacron_prod -d novacron_production -c "SELECT version();"

# Check database logs
docker service logs novacron_postgres
```

#### 3. SSL Certificate Issues

```bash
# Verify certificate
openssl x509 -in /path/to/cert.pem -text -noout

# Test SSL connection
openssl s_client -servername your-domain.com -connect your-domain.com:443

# Check certificate expiration
./scripts/production/ssl/generate-ssl.sh validate
```

#### 4. Performance Issues

```bash
# Check resource usage
docker stats
htop

# Review Grafana dashboards
# Access: https://your-domain.com/grafana

# Check slow queries
docker exec -it novacron_postgres psql -U novacron_prod -d novacron_production -c "
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements 
ORDER BY total_time DESC 
LIMIT 10;"
```

### Rollback Procedures

#### Rollback to Previous Version
```bash
./scripts/production/rollback.sh docker-swarm previous  # Swarm
./scripts/production/rollback.sh kubernetes previous    # Kubernetes
```

#### Rollback to Specific Version
```bash
./scripts/production/rollback.sh docker-swarm v1.2.3
./scripts/production/rollback.sh kubernetes v1.2.3
```

#### Emergency Restore from Backup
```bash
./scripts/production/rollback.sh emergency-restore backup-20240101
```

### Log Analysis

```bash
# Application logs
tail -f /var/log/novacron/application.log

# Container logs  
docker logs -f novacron_api.1.xyz  # Swarm
kubectl logs -f deployment/novacron-api -n novacron  # Kubernetes

# Database logs
docker service logs novacron_postgres
```

### Performance Tuning

#### Database Optimization
```bash
# Connect to database
docker exec -it novacron_postgres psql -U novacron_prod -d novacron_production

# Analyze queries
EXPLAIN ANALYZE SELECT * FROM vms WHERE status = 'running';

# Update statistics
ANALYZE;
```

#### Resource Scaling

**Docker Swarm:**
```bash
# Scale API service
docker service update --replicas 5 novacron_api

# Update resource limits
docker service update --limit-memory 2G --limit-cpu 2 novacron_api
```

**Kubernetes:**
```bash
# Scale deployment
kubectl scale deployment novacron-api --replicas=5 -n novacron

# Update resource limits
kubectl patch deployment novacron-api -n novacron -p '{"spec":{"template":{"spec":{"containers":[{"name":"api","resources":{"limits":{"memory":"2Gi","cpu":"2"}}}]}}}}'
```

## Security Checklist

- [ ] Strong passwords generated for all services
- [ ] SSL/TLS certificates configured and valid
- [ ] Firewall rules configured (only necessary ports open)
- [ ] Secret rotation schedule established
- [ ] Regular security updates planned
- [ ] Monitoring and alerting configured
- [ ] Backup and restore procedures tested
- [ ] Access control and RBAC configured
- [ ] Network segmentation implemented
- [ ] Audit logging enabled

## Maintenance Schedule

### Daily
- Check service health
- Monitor resource usage
- Review error logs

### Weekly
- Update container images
- Review security alerts
- Test backup procedures

### Monthly
- Rotate secrets
- Update SSL certificates
- Performance review
- Security scan

### Quarterly
- Major version updates
- Disaster recovery test
- Security audit
- Capacity planning review

## Support

For additional support:
- Check logs and monitoring dashboards first
- Review this guide and troubleshooting section
- Search existing issues in the project repository
- Create detailed bug reports with logs and configuration

Remember to never share production secrets or sensitive configuration in support requests.