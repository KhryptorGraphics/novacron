name: E2E Nightly Tests

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      browsers:
        description: 'Browsers to test (comma-separated)'
        required: false
        default: 'chromium,firefox,webkit'
      environment:
        description: 'Test environment'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production-like
          - local

env:
  NODE_VERSION: '18'
  EXTENDED_TIMEOUT_MINUTES: 120

jobs:
  # Pre-flight checks
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if nightly should run
        id: check
        run: |
          # Check if there were commits in the last 24 hours
          commits=$(git log --since="24 hours ago" --oneline | wc -l)
          if [ $commits -gt 0 ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "No commits in the last 24 hours. Skipping nightly run."
          fi

  # Full dependency installation
  install:
    name: Install Dependencies
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install all dependencies
        run: |
          npm ci
          cd tests/e2e && npm ci

      - name: Install Playwright browsers
        run: cd tests/e2e && npx playwright install --with-deps chromium firefox webkit

      - name: Cache installation
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            tests/e2e/node_modules
            ~/.cache/ms-playwright
          key: nightly-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.run_id }}

  # Build application
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            tests/e2e/node_modules
          key: nightly-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.run_id }}

      - name: Build application
        run: npm run build
        env:
          CI: true
          NODE_ENV: production

      - name: Upload build
        uses: actions/upload-artifact@v3
        with:
          name: nightly-build
          path: |
            dist/
            build/
          retention-days: 3

  # Comprehensive browser testing
  test-browsers:
    name: Test All Browsers (${{ matrix.browser }})
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit, 'chromium-mobile', 'webkit-mobile']
        include:
          - browser: chromium
            project: chromium
          - browser: firefox
            project: firefox
          - browser: webkit
            project: webkit
          - browser: chromium-mobile
            project: 'Mobile Chrome'
          - browser: webkit-mobile
            project: 'Mobile Safari'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            tests/e2e/node_modules
            ~/.cache/ms-playwright
          key: nightly-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.run_id }}

      - name: Download build
        uses: actions/download-artifact@v3
        with:
          name: nightly-build

      - name: Setup test environment
        run: |
          chmod +x tests/e2e/scripts/setup-test-env.sh
          ./tests/e2e/scripts/setup-test-env.sh
        env:
          TEST_ENV: nightly

      - name: Start services
        run: |
          cd tests/e2e/docker
          docker-compose -f docker-compose.yml -f docker-compose.nightly.yml up -d
        env:
          COMPOSE_PROJECT_NAME: e2e-nightly-${{ matrix.browser }}

      - name: Seed test data
        run: |
          chmod +x tests/e2e/scripts/seed-test-data.sh
          ./tests/e2e/scripts/seed-test-data.sh

      - name: Run comprehensive tests
        run: |
          cd tests/e2e
          npx playwright test --project="${{ matrix.project }}" --reporter=html,json,junit
        env:
          CI: true
          TEST_BASE_URL: http://localhost:3000
          API_BASE_URL: http://localhost:8080
          EXTENDED_TIMEOUT: '120000'
          SLOW_MO: '100'

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: nightly-results-${{ matrix.browser }}
          path: |
            tests/e2e/playwright-report/
            tests/e2e/test-results/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          cd tests/e2e/docker
          docker-compose -f docker-compose.yml -f docker-compose.nightly.yml down -v

  # Performance benchmarking
  performance-benchmark:
    name: Performance Benchmarking
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            tests/e2e/node_modules
            ~/.cache/ms-playwright
          key: nightly-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.run_id }}

      - name: Download build
        uses: actions/download-artifact@v3
        with:
          name: nightly-build

      - name: Setup test environment
        run: |
          chmod +x tests/e2e/scripts/setup-test-env.sh
          ./tests/e2e/scripts/setup-test-env.sh

      - name: Start services
        run: |
          cd tests/e2e/docker
          docker-compose up -d

      - name: Run performance tests
        run: |
          cd tests/e2e
          npx playwright test --project=chromium --grep @performance --reporter=json
        env:
          BENCHMARK_MODE: 'true'
          TRACE_ENABLED: 'true'

      - name: Analyze performance metrics
        run: |
          cd tests/e2e
          node scripts/analyze-performance.js

      - name: Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: performance-benchmark
          path: tests/e2e/reports/performance/
          retention-days: 90

      - name: Compare with baseline
        run: |
          cd tests/e2e
          node scripts/compare-performance.js

      - name: Cleanup
        if: always()
        run: |
          cd tests/e2e/docker
          docker-compose down -v

  # Accessibility testing
  accessibility:
    name: Accessibility Testing
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            tests/e2e/node_modules
            ~/.cache/ms-playwright
          key: nightly-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.run_id }}

      - name: Download build
        uses: actions/download-artifact@v3
        with:
          name: nightly-build

      - name: Run accessibility tests
        run: |
          cd tests/e2e
          npx playwright test --project=chromium --grep @accessibility

      - name: Upload accessibility report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: accessibility-report
          path: tests/e2e/reports/accessibility/
          retention-days: 30

  # Generate comprehensive report
  generate-report:
    name: Generate Nightly Report
    runs-on: ubuntu-latest
    needs: [test-browsers, performance-benchmark, accessibility]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: nightly-artifacts

      - name: Generate comprehensive report
        run: |
          mkdir -p reports/nightly
          node tests/e2e/scripts/generate-nightly-report.js
        env:
          ARTIFACTS_PATH: nightly-artifacts
          REPORT_DATE: ${{ github.run_number }}

      - name: Upload comprehensive report
        uses: actions/upload-artifact@v3
        with:
          name: nightly-comprehensive-report-${{ github.run_number }}
          path: reports/nightly/
          retention-days: 90

      - name: Archive report
        run: |
          tar -czf nightly-report-${{ github.run_number }}.tar.gz reports/nightly/

      - name: Upload archived report
        uses: actions/upload-artifact@v3
        with:
          name: nightly-report-archive
          path: nightly-report-${{ github.run_number }}.tar.gz
          retention-days: 365

  # Notify results
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [test-browsers, performance-benchmark, accessibility]
    if: always()
    steps:
      - name: Check test results
        id: check-results
        run: |
          if [ "${{ needs.test-browsers.result }}" = "failure" ] || \
             [ "${{ needs.performance-benchmark.result }}" = "failure" ] || \
             [ "${{ needs.accessibility.result }}" = "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Send notification
        run: |
          echo "Nightly E2E test run completed with status: ${{ steps.check-results.outputs.status }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # Add notification integration (Slack, email, etc.)

      - name: Create issue on failure
        if: steps.check-results.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Nightly E2E Tests Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `The nightly E2E test run has failed.\n\n**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n**Date:** ${new Date().toISOString()}\n\nPlease investigate and fix the failing tests.`,
              labels: ['e2e-test-failure', 'automated', 'priority:high']
            });
