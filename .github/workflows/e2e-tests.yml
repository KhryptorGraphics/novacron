name: E2E Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'tests/e2e/**'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'tests/e2e/**'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit

env:
  NODE_VERSION: '18'
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '0'

jobs:
  # Job to detect changes and determine test scope
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      e2e: ${{ steps.filter.outputs.e2e }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'
            e2e:
              - 'tests/e2e/**'

  # Install and cache dependencies
  install:
    runs-on: ubuntu-latest
    needs: changes
    if: |
      needs.changes.outputs.frontend == 'true' ||
      needs.changes.outputs.backend == 'true' ||
      needs.changes.outputs.e2e == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            tests/e2e/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            tests/e2e/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          npm ci
          cd tests/e2e && npm ci

      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('tests/e2e/package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: cd tests/e2e && npx playwright install --with-deps

      - name: Install Playwright browser dependencies only
        if: steps.cache-playwright.outputs.cache-hit == 'true'
        run: cd tests/e2e && npx playwright install-deps

  # Build application for testing
  build:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            tests/e2e/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: Build application
        run: npm run build
        env:
          CI: true
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            dist/
            build/
          retention-days: 1

  # Matrix strategy for parallel test execution
  test-e2e:
    name: E2E Tests (${{ matrix.os }}, ${{ matrix.browser }}, shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
    runs-on: ${{ matrix.os }}
    needs: [changes, build]
    if: |
      needs.changes.outputs.frontend == 'true' ||
      needs.changes.outputs.backend == 'true' ||
      needs.changes.outputs.e2e == 'true'
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        browser: [chromium, firefox, webkit]
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]
        include:
          # Optional: Add Windows and macOS for comprehensive testing
          # - os: windows-latest
          #   browser: chromium
          #   shardIndex: 1
          #   shardTotal: 2
          # - os: macos-latest
          #   browser: webkit
          #   shardIndex: 1
          #   shardTotal: 2

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            tests/e2e/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: Restore Playwright browsers cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('tests/e2e/package-lock.json') }}

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: Setup test environment
        run: |
          chmod +x tests/e2e/scripts/setup-test-env.sh
          ./tests/e2e/scripts/setup-test-env.sh
        env:
          TEST_ENV: ci
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379

      - name: Start services with Docker Compose
        run: |
          cd tests/e2e/docker
          docker-compose up -d
          docker-compose ps
        env:
          COMPOSE_PROJECT_NAME: e2e-tests-${{ matrix.browser }}-${{ matrix.shardIndex }}

      - name: Wait for services to be healthy
        run: |
          timeout 60 bash -c 'until docker-compose -f tests/e2e/docker/docker-compose.yml ps | grep healthy; do sleep 2; done' || (docker-compose -f tests/e2e/docker/docker-compose.yml logs && exit 1)

      - name: Seed test data
        run: |
          chmod +x tests/e2e/scripts/seed-test-data.sh
          ./tests/e2e/scripts/seed-test-data.sh
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db

      - name: Run Playwright tests
        run: |
          cd tests/e2e
          npx playwright test --project=${{ matrix.browser }} --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} --reporter=html,json,line
        env:
          CI: true
          PLAYWRIGHT_BROWSER: ${{ matrix.browser }}
          TEST_BASE_URL: http://localhost:3000
          API_BASE_URL: http://localhost:8080
          PWTEST_SKIP_TEST_OUTPUT: '1'
        continue-on-error: false

      - name: Retry failed tests
        if: failure()
        run: |
          cd tests/e2e
          npx playwright test --project=${{ matrix.browser }} --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} --only-failed --reporter=html,json,line
        env:
          CI: true
          PLAYWRIGHT_BROWSER: ${{ matrix.browser }}
          TEST_BASE_URL: http://localhost:3000
          API_BASE_URL: http://localhost:8080

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.browser }}-${{ matrix.shardIndex }}
          path: tests/e2e/test-results/
          retention-days: 7

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report-${{ matrix.os }}-${{ matrix.browser }}-${{ matrix.shardIndex }}
          path: tests/e2e/playwright-report/
          retention-days: 7

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: screenshots-${{ matrix.os }}-${{ matrix.browser }}-${{ matrix.shardIndex }}
          path: tests/e2e/test-results/**/*-screenshots/**
          retention-days: 7

      - name: Upload videos
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: videos-${{ matrix.os }}-${{ matrix.browser }}-${{ matrix.shardIndex }}
          path: tests/e2e/test-results/**/*.webm
          retention-days: 7

      - name: Upload traces
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: traces-${{ matrix.os }}-${{ matrix.browser }}-${{ matrix.shardIndex }}
          path: tests/e2e/test-results/**/*.zip
          retention-days: 7

      - name: Cleanup test environment
        if: always()
        run: |
          chmod +x tests/e2e/scripts/cleanup-test-env.sh
          ./tests/e2e/scripts/cleanup-test-env.sh
          cd tests/e2e/docker
          docker-compose down -v
        env:
          COMPOSE_PROJECT_NAME: e2e-tests-${{ matrix.browser }}-${{ matrix.shardIndex }}

  # Merge test results and generate combined report
  merge-reports:
    name: Merge Test Reports
    runs-on: ubuntu-latest
    needs: test-e2e
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: all-artifacts

      - name: Merge Playwright reports
        run: |
          npx playwright merge-reports --reporter html,json all-artifacts/playwright-report-*

      - name: Upload merged report
        uses: actions/upload-artifact@v3
        with:
          name: merged-playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Generate test summary
        if: always()
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse JSON reports and generate summary
          total_tests=0
          passed_tests=0
          failed_tests=0
          skipped_tests=0

          for report in all-artifacts/playwright-report-*/results.json; do
            if [ -f "$report" ]; then
              tests=$(jq '.suites | length' "$report" || echo "0")
              passed=$(jq '[.suites[].specs[] | select(.ok == true)] | length' "$report" || echo "0")
              failed=$(jq '[.suites[].specs[] | select(.ok == false)] | length' "$report" || echo "0")

              total_tests=$((total_tests + tests))
              passed_tests=$((passed_tests + passed))
              failed_tests=$((failed_tests + failed))
            fi
          done

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $total_tests |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | âœ… $passed_tests |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | âŒ $failed_tests |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $failed_tests -gt 0 ]; then
            echo "âš ï¸ Some tests failed. Check the artifacts for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
          fi

  # Comment test results on PR
  comment-pr:
    name: Comment Test Results on PR
    runs-on: ubuntu-latest
    needs: merge-reports
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write
    steps:
      - name: Download merged report
        uses: actions/download-artifact@v3
        with:
          name: merged-playwright-report
          path: playwright-report

      - name: Create comment body
        id: create-comment
        run: |
          echo "## ðŸŽ­ Playwright E2E Test Results" > comment.md
          echo "" >> comment.md
          echo "**Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> comment.md
          echo "**Commit:** ${{ github.event.pull_request.head.sha }}" >> comment.md
          echo "" >> comment.md

          if [ -f "playwright-report/results.json" ]; then
            total=$(jq '.suites | length' playwright-report/results.json || echo "0")
            passed=$(jq '[.suites[].specs[] | select(.ok == true)] | length' playwright-report/results.json || echo "0")
            failed=$(jq '[.suites[].specs[] | select(.ok == false)] | length' playwright-report/results.json || echo "0")

            echo "| Status | Count |" >> comment.md
            echo "|--------|-------|" >> comment.md
            echo "| Total | $total |" >> comment.md
            echo "| âœ… Passed | $passed |" >> comment.md
            echo "| âŒ Failed | $failed |" >> comment.md
            echo "" >> comment.md

            if [ $failed -gt 0 ]; then
              echo "âš ï¸ **Action Required:** Some E2E tests failed. Please review the test results." >> comment.md
            else
              echo "âœ… **All E2E tests passed!**" >> comment.md
            fi
          else
            echo "âš ï¸ Could not parse test results." >> comment.md
          fi

          echo "" >> comment.md
          echo "ðŸ“Š [View Full Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> comment.md

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Playwright E2E Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  # Notify on failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: test-e2e
    if: failure()
    steps:
      - name: Send failure notification
        run: |
          echo "E2E tests failed for commit ${{ github.sha }}"
          echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # Add your notification logic here (Slack, email, etc.)
