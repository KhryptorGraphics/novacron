name: Visual Regression Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'tests/e2e/visual/**'
      - '.github/workflows/e2e-visual-regression.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'tests/e2e/visual/**'
  workflow_dispatch:
    inputs:
      update_baseline:
        description: 'Update baseline screenshots'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  # Setup and baseline management
  setup-baseline:
    name: Setup Visual Baseline
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for existing baseline
        id: check-baseline
        run: |
          if [ -d "tests/e2e/visual/baseline" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Download baseline from artifacts
        if: steps.check-baseline.outputs.exists == 'false'
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: e2e-visual-regression.yml
          name: visual-baseline
          path: tests/e2e/visual/baseline
          if_no_artifact_found: warn

      - name: Upload baseline
        uses: actions/upload-artifact@v3
        with:
          name: visual-baseline-current
          path: tests/e2e/visual/baseline/
          retention-days: 30

  # Visual regression testing
  visual-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    needs: setup-baseline
    strategy:
      fail-fast: false
      matrix:
        viewport: ['desktop', 'tablet', 'mobile']
        theme: ['light', 'dark']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd tests/e2e && npm ci

      - name: Install Playwright
        run: cd tests/e2e && npx playwright install --with-deps chromium

      - name: Download baseline
        uses: actions/download-artifact@v3
        with:
          name: visual-baseline-current
          path: tests/e2e/visual/baseline

      - name: Build application
        run: npm run build
        env:
          CI: true

      - name: Start services
        run: |
          cd tests/e2e/docker
          docker-compose up -d

      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'

      - name: Run visual tests
        run: |
          cd tests/e2e
          npx playwright test visual/ \
            --project=chromium \
            --grep "@visual" \
            --reporter=html,json
        env:
          VIEWPORT: ${{ matrix.viewport }}
          THEME: ${{ matrix.theme }}
          UPDATE_SNAPSHOTS: ${{ github.event.inputs.update_baseline == 'true' }}

      - name: Compare screenshots
        if: always()
        run: |
          cd tests/e2e
          node scripts/compare-visual.js \
            --viewport=${{ matrix.viewport }} \
            --theme=${{ matrix.theme }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: visual-test-results-${{ matrix.viewport }}-${{ matrix.theme }}
          path: |
            tests/e2e/test-results/
            tests/e2e/visual/actual/
            tests/e2e/visual/diff/
          retention-days: 14

      - name: Upload diff images
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: visual-diff-${{ matrix.viewport }}-${{ matrix.theme }}
          path: tests/e2e/visual/diff/
          retention-days: 14

      - name: Cleanup
        if: always()
        run: |
          cd tests/e2e/docker
          docker-compose down -v

  # Update baseline (only on manual trigger or main branch)
  update-baseline:
    name: Update Visual Baseline
    runs-on: ubuntu-latest
    needs: visual-tests
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.update_baseline == 'true') ||
      (github.ref == 'refs/heads/main' && github.event_name == 'push')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download all visual results
        uses: actions/download-artifact@v3
        with:
          path: visual-results

      - name: Merge baselines
        run: |
          mkdir -p tests/e2e/visual/baseline
          cd visual-results
          for dir in visual-test-results-*; do
            if [ -d "$dir/visual/actual" ]; then
              cp -r "$dir/visual/actual/"* ../tests/e2e/visual/baseline/
            fi
          done

      - name: Commit baseline updates
        if: github.event.inputs.update_baseline == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tests/e2e/visual/baseline/
          git commit -m "chore: update visual regression baseline [skip ci]" || echo "No changes to commit"
          git push

      - name: Upload new baseline
        uses: actions/upload-artifact@v3
        with:
          name: visual-baseline
          path: tests/e2e/visual/baseline/
          retention-days: 90

  # Generate visual regression report
  generate-visual-report:
    name: Generate Visual Report
    runs-on: ubuntu-latest
    needs: visual-tests
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: all-visual-results

      - name: Generate HTML report
        run: |
          mkdir -p reports/visual
          node tests/e2e/scripts/generate-visual-report.js
        env:
          RESULTS_PATH: all-visual-results

      - name: Upload visual report
        uses: actions/upload-artifact@v3
        with:
          name: visual-regression-report
          path: reports/visual/
          retention-days: 30

      - name: Generate summary
        run: |
          echo "## Visual Regression Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          total_tests=0
          passed_tests=0
          failed_tests=0

          for result in all-visual-results/visual-test-results-*/results.json; do
            if [ -f "$result" ]; then
              tests=$(jq '.suites | length' "$result" || echo "0")
              passed=$(jq '[.suites[].specs[] | select(.ok == true)] | length' "$result" || echo "0")
              failed=$(jq '[.suites[].specs[] | select(.ok == false)] | length' "$result" || echo "0")

              total_tests=$((total_tests + tests))
              passed_tests=$((passed_tests + passed))
              failed_tests=$((failed_tests + failed))
            fi
          done

          echo "| Viewport/Theme | Tests | Passed | Failed |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | $total_tests | âœ… $passed_tests | âŒ $failed_tests |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $failed_tests -gt 0 ]; then
            echo "âš ï¸ Visual differences detected. Review the diff images." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No visual regressions detected!" >> $GITHUB_STEP_SUMMARY
          fi

  # Comment on PR with visual changes
  comment-visual-pr:
    name: Comment Visual Changes on PR
    runs-on: ubuntu-latest
    needs: generate-visual-report
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write
    steps:
      - name: Download visual report
        uses: actions/download-artifact@v3
        with:
          name: visual-regression-report
          path: visual-report

      - name: Download diff images
        uses: actions/download-artifact@v3
        with:
          path: visual-diffs
        continue-on-error: true

      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let comment = '## ðŸŽ¨ Visual Regression Test Results\n\n';
            comment += `**Workflow:** [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n`;

            // Check for diff images
            const diffDirs = fs.readdirSync('visual-diffs', { withFileTypes: true })
              .filter(dirent => dirent.isDirectory())
              .map(dirent => dirent.name);

            if (diffDirs.length > 0) {
              comment += '### âš ï¸ Visual Changes Detected\n\n';
              comment += 'The following screenshots have changed:\n\n';

              diffDirs.forEach(dir => {
                comment += `- **${dir}**\n`;
              });

              comment += '\nðŸ“Š [View Full Visual Report](' + context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ')\n';
            } else {
              comment += 'âœ… No visual regressions detected!\n';
            }

            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Visual Regression Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
