apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: novacron
spec:
  provider:
    vault:
      server: "https://vault.novacron.io"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "novacron"
          serviceAccountRef:
            name: novacron
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: novacron
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: novacron
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: novacron-database-credentials
  namespace: novacron
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: database-credentials
    creationPolicy: Owner
  data:
    - secretKey: username
      remoteRef:
        key: database/novacron
        property: username
    - secretKey: password
      remoteRef:
        key: database/novacron
        property: password
    - secretKey: connection-string
      remoteRef:
        key: database/novacron
        property: connection_string
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: novacron-api-keys
  namespace: novacron
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: api-keys
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: api-keys/novacron
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: novacron-tls-certificates
  namespace: novacron
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: tls-certificates
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  data:
    - secretKey: tls.crt
      remoteRef:
        key: certificates/novacron
        property: certificate
    - secretKey: tls.key
      remoteRef:
        key: certificates/novacron
        property: private_key
    - secretKey: ca.crt
      remoteRef:
        key: certificates/novacron
        property: ca_certificate
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: rotate-secrets
  namespace: novacron
spec:
  schedule: "0 0 * * 0"  # Weekly on Sunday
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: secret-rotator
          containers:
            - name: rotator
              image: novacron/secret-rotator:3.0.0
              command:
                - /usr/local/bin/rotate-secrets.sh
              env:
                - name: VAULT_ADDR
                  value: "https://vault.novacron.io"
                - name: ROTATION_POLICY
                  value: "weekly"
          restartPolicy: OnFailure
